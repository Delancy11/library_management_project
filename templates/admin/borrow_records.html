{% extends "base.html" %}

{% block title %}借阅记录 - 图书管理系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="bi bi-clock-history"></i> 借阅记录管理</h2>
        <p class="text-muted">查看和管理所有用户的图书借阅记录</p>
    </div>
</div>

<!-- 搜索和筛选 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" class="row g-3">
                    <div class="col-md-3">
                        <input type="text" class="form-control" name="search" placeholder="搜索图书、用户..." value="{{ request.args.get('search', '') }}">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" name="status">
                            <option value="">所有状态</option>
                            <option value="borrowed" {% if request.args.get('status') == 'borrowed' %}selected{% endif %}>借阅中</option>
                            <option value="returned" {% if request.args.get('status') == 'returned' %}selected{% endif %}>已归还</option>
                            <option value="overdue" {% if request.args.get('status') == 'overdue' %}selected{% endif %}>已逾期</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" name="days">
                            <option value="">所有时间</option>
                            <option value="7" {% if request.args.get('days') == '7' %}selected{% endif %}>最近7天</option>
                            <option value="30" {% if request.args.get('days') == '30' %}selected{% endif %}>最近30天</option>
                            <option value="90" {% if request.args.get('days') == '90' %}selected{% endif %}>最近90天</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" name="date_from" value="{{ request.args.get('date_from', '') }}" placeholder="开始日期">
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i> 搜索
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 借阅记录列表 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="bi bi-list-check"></i> 借阅记录</h5>
                <span class="badge bg-primary">共 {{ records.total }} 条记录</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>记录ID</th>
                                <th>图书信息</th>
                                <th>用户信息</th>
                                <th>借阅日期</th>
                                <th>应还日期</th>
                                <th>归还日期</th>
                                <th>状态</th>
                                <th>借阅天数</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in records.items %}
                                <tr>
                                    <td>#{{ record.id }}</td>
                                    <td>
                                        <strong>{{ record.book.title }}</strong><br>
                                        <small class="text-muted">{{ record.book.author }}</small><br>
                                        <small class="text-muted">ISBN: {{ record.book.isbn }}</small>
                                    </td>
                                    <td>
                                        <strong>{{ record.user.username }}</strong><br>
                                        <small class="text-muted">{{ record.user.full_name or record.user.email }}</small>
                                    </td>
                                    <td>{{ record.borrow_date.strftime('%Y-%m-%d') }}</td>
                                    <td>
                                        {% if record.is_overdue() %}
                                            <span class="text-danger fw-bold">{{ record.due_date.strftime('%Y-%m-%d') }}</span>
                                        {% else %}
                                            {{ record.due_date.strftime('%Y-%m-%d') }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if record.return_date %}
                                            {{ record.return_date.strftime('%Y-%m-%d') }}
                                        {% else %}
                                            <span class="text-muted">未归还</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if record.status == 'borrowed' %}
                                            {% if record.is_overdue() %}
                                                <span class="badge bg-danger">已逾期</span>
                                            {% else %}
                                                <span class="badge bg-warning">借阅中</span>
                                            {% endif %}
                                        {% elif record.status == 'returned' %}
                                            <span class="badge bg-success">已归还</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if record.return_date %}
                                            {{ (record.return_date - record.borrow_date).days }} 天
                                        {% else %}
                                            {{ (datetime.utcnow() - record.borrow_date).days }} 天
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if record.status == 'borrowed' %}
                                            <button class="btn btn-sm btn-success" onclick="markAsReturned({{ record.id }})">
                                                <i class="bi bi-check-circle"></i> 标记归还
                                            </button>
                                        {% else %}
                                            <button class="btn btn-sm btn-secondary" disabled>
                                                <i class="bi bi-check2"></i> 已归还
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                {% if not records.items %}
                    <div class="text-center py-5">
                        <i class="bi bi-clock-history" style="font-size: 4rem; color: #ccc;"></i>
                        <h4 class="mt-3">暂无借阅记录</h4>
                        <p class="text-muted">
                            {% if request.args.get('search') or request.args.get('status') or request.args.get('date_from') %}
                                没有找到符合条件的借阅记录，请尝试其他搜索条件。
                            {% else %}
                                系统中还没有借阅记录。
                            {% endif %}
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 分页 -->
{% if records.pages > 1 %}
<div class="row">
    <div class="col-12">
        <nav aria-label="借阅记录分页">
            <ul class="pagination justify-content-center">
                {% if records.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('admin_borrow_records', page=records.prev_num, search=request.args.get('search'), status=request.args.get('status'), date_from=request.args.get('date_from'), days=request.args.get('days')) }}">
                            <i class="bi bi-chevron-left"></i> 上一页
                        </a>
                    </li>
                {% endif %}

                {% for page_num in records.iter_pages() %}
                    {% if page_num %}
                        {% if page_num != records.page %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('admin_borrow_records', page=page_num, search=request.args.get('search'), status=request.args.get('status'), date_from=request.args.get('date_from'), days=request.args.get('days')) }}">
                                    {{ page_num }}
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                        {% endif %}
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if records.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('admin_borrow_records', page=records.next_num, search=request.args.get('search'), status=request.args.get('status'), date_from=request.args.get('date_from'), days=request.args.get('days')) }}">
                            下一页 <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>
{% endif %}

<!-- 统计信息 -->
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ records.total }}</h4>
                        <p>总借阅记录</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-clock-history" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ records.items|selectattr('status', 'equalto', 'borrowed')|list|length }}</h4>
                        <p>当前借阅</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-book" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ records.items|selectattr('status', 'equalto', 'returned')|list|length }}</h4>
                        <p>已归还</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-check-circle" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ records.items|selectattr('is_overdue')|list|length }}</h4>
                        <p>已逾期</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 快速操作 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-lightning"></i> 快速操作</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-primary w-100">
                            <i class="bi bi-speedometer2"></i> 仪表板
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('admin_users') }}" class="btn btn-outline-success w-100">
                            <i class="bi bi-people"></i> 用户管理
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('admin_books') }}" class="btn btn-outline-info w-100">
                            <i class="bi bi-book"></i> 图书管理
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{{ url_for('admin_categories') }}" class="btn btn-outline-warning w-100">
                            <i class="bi bi-tags"></i> 分类管理
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 标记为已归还
function markAsReturned(recordId) {
    if (confirm('确定要标记这条记录为已归还吗？')) {
        // 这里可以通过AJAX调用后端API来更新记录状态
        // 由于我们没有实现这个API，这里只是演示
        alert('标记归还功能需要后端API支持');

        // 模拟API调用
        // fetch(`/admin/records/${recordId}/return`, { method: 'POST' })
        //     .then(response => response.json())
        //     .then(data => {
        //         if (data.success) {
        //             location.reload();
        //         } else {
        //             alert('操作失败：' + data.message);
        //         }
        //     });
    }
}

// 清除搜索条件
function clearFilters() {
    window.location.href = '{{ url_for("admin_borrow_records") }}';
}

// 自动刷新逾期记录
setInterval(function() {
    // 每5分钟检查一次逾期记录
    const overdueCount = {{ records.items|selectattr('is_overdue')|list|length }};
    if (overdueCount > 0) {
        document.querySelector('.badge.bg-danger').parentElement.parentElement.classList.add('border-danger');
    }
}, 300000); // 5分钟
</script>
{% endblock %}